name: ðŸ§ª Tests & Coverage Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests & Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸ§ª Run Tests
        run: mvn clean test

      - name: ðŸ“Š Generate Coverage Report
        run: mvn jacoco:report

      - name: ðŸ“ Publish Test Results
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: ðŸ§ª JUnit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: ðŸ“ˆ Generate Detailed Test Report
        uses: ScaCap/action-surefire-report@v1
        with:
          github_token: \${{ secrets.GITHUB_TOKEN }}
          report_paths: 'target/surefire-reports/TEST-*.xml'

      - name: ðŸ“Š Coverage Report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: target/site/jacoco/jacoco.xml
          badge: true
          format: 'markdown'
          output: 'both'
          indicators: true

      - name: â­ Generate JaCoCo Badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          generate-branches-badge: true
          generate-coverage-badge: true

      - name: ðŸ’¾ Upload Coverage Report
        uses: actions/upload-artifact@v3
        with:
          name: ðŸ“Š Coverage Report
          path: |
            target/site/jacoco/
            .github/badges

      - name: ðŸ’¬ Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: code-coverage-results.md

      - name: ðŸ“Š Generate Test Summary
        if: always()
        uses: test-summary/action@v2
        with:
          paths: "target/surefire-reports/TEST-*.xml"

      - name: ðŸ“ˆ Create Coverage Badge
        uses: schneegans/dynamic-badges-action@v1.6.0
        with:
          auth: \${{ secrets.GIST_SECRET }}
          gistID: YOUR_GIST_ID # Create a gist and put its ID here
          filename: coverage.json
          label: Coverage
          message: \${{ steps.jacoco.outputs.coverage }}%
          color: \${{ steps.jacoco.outputs.coverage >= 80 && 'green' || steps.jacoco.outputs.coverage >= 70 && 'yellow' || 'red' }}
          namedLogo: junit5

      - name: ðŸ“‹ Create Beautiful Report
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const coverageReport = fs.readFileSync('code-coverage-results.md', 'utf8');
            const testResults = fs.readFileSync('test-summary.md', 'utf8');
            
            const report = `# ðŸ“Š Test & Coverage Report
            
            ## ðŸ§ª Test Results
            \${testResults}
            
            ## ðŸ“ˆ Coverage Analysis
            \${coverageReport}
            
            ## ðŸŽ¯ Coverage Targets
            - âœ… Line Coverage: 80%
            - âœ… Branch Coverage: 70%
            - âœ… Method Coverage: 75%
            
            [View detailed coverage report](\${process.env.GITHUB_SERVER_URL}/\${process.env.GITHUB_REPOSITORY}/actions/runs/\${process.env.GITHUB_RUN_ID})
            `;
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: ðŸ“Š Upload HTML Report
        uses: actions/upload-artifact@v3
        with:
          name: ðŸ“ˆ Coverage HTML Report
          path: target/site/jacoco
          if-no-files-found: error